<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Affirmation Card Print Sheet — 2x5 Fixed</title>
<style>
  * { box-sizing: border-box }
  body { font-family: Arial, Helvetica, sans-serif; padding: 1rem; background: #f7f7f7; color: #222 }
  h1 { text-align: center; margin-bottom: .6rem }
  .controls { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: center; margin-bottom: 1rem }
  .controls label { display: flex; flex-direction: column; font-size: .88rem; text-align: center }
  .thumbs { display: flex; flex-wrap: wrap; gap: .5rem; margin-bottom: 1rem; justify-content: center }
  .thumb { width: 70px; height: 40px; overflow: hidden; border: 1px solid #ccc; border-radius: 4px; background: #fff; position: relative }
  .thumb img { width: 100%; height: 100%; object-fit: cover; display: block }
  .idx { position: absolute; right: 4px; bottom: 2px; background: rgba(0,0,0,.6); color: #fff; padding: 2px 4px; font-size: .7rem; border-radius: 3px }
  .pages-wrapper { display: flex; flex-direction: column; gap: 1rem; align-items: center }
  .sheet { background: white; border: 1px solid #bbb; box-shadow: 0 2px 6px rgba(0,0,0,.06); overflow: visible }
  .page-content { width: 100%; height: 100%; padding: 0; display: flex; align-items: center; justify-content: center }
  .grid { display: grid; justify-items: center; align-content: center }
  .slot { position: relative }
  .card-box { width: 100%; height: 100%; overflow: hidden }
  .card-box img { width: 100%; height: 100%; object-fit: contain; display: block }
  .cut { position: absolute; left: 0; top: 0; right: 0; bottom: 0; border: 1px dashed #000; pointer-events: none; box-sizing: border-box }
  .print-area { position: absolute; left: -9999px; top: -9999px }
  .muted { color: #666; text-align: center }
  @media (max-width: 420px) { .controls { gap: .35rem } .thumb { width: 60px; height: 36px } }
</style>
</head>
<body>
  <h1>Affirmation Card Print Sheet — 2 × 5</h1>

  <div class="controls">
    <input id="files" type="file" accept="image/*" multiple>
    <button id="clearBtn">Clear</button>
    <button id="generateBtn">Generate</button>
    <button id="downloadSheetBtn">Download PNG</button>

    <label>Page Size
      <select id="pageSize">
        <option value="letter">Letter (8.5×11 in)</option>
        <option value="a4">A4 (210×297 mm)</option>
      </select>
    </label>

    <label>Orientation
      <select id="orientation">
        <option value="portrait">Portrait</option>
        <option value="landscape">Landscape</option>
      </select>
    </label>

    <label>Margin (in)
      <input id="margin" type="number" step="0.01" value="0.25" style="width:86px;">
    </label>

    <label>Cols × Rows
      <input id="cols" type="number" value="2" min="1" style="width:48px;"> ×
      <input id="rows" type="number" value="5" min="1" style="width:48px;">
    </label>

    <label>Show Crop Marks
      <input id="cropMarks" type="checkbox" checked>
    </label>
  </div>

  <div id="thumbs" class="thumbs"></div>
  <div class="pages-wrapper"></div>
  <div class="print-area"></div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  // ---------- Config ----------
  let files = [];
  const cardDimensions = { width: 3.5, height: 2 }; // inches (standard business card)
  const DPI = 300; // High resolution for real-world dimensions
  const BLEED = 0.125; // 1/8 inch bleed area for safe cutting
  let lastPages = null;

  // DOM
  const fileInput = document.getElementById('files');
  const thumbs = document.getElementById('thumbs');
  const clearBtn = document.getElementById('clearBtn');
  const generateBtn = document.getElementById('generateBtn');
  const downloadBtn = document.getElementById('downloadSheetBtn');
  const pageSizeSelect = document.getElementById('pageSize');
  const orientationSelect = document.getElementById('orientation');
  const marginInput = document.getElementById('margin');
  const colsInput = document.getElementById('cols');
  const rowsInput = document.getElementById('rows');
  const cropInput = document.getElementById('cropMarks');
  const pagesWrapper = document.querySelector('.pages-wrapper');
  const printArea = document.querySelector('.print-area');

  // Events
  fileInput.addEventListener('change', handleFileSelect);
  clearBtn.addEventListener('click', clearAll);
  generateBtn.addEventListener('click', generatePrintSheet);
  downloadBtn.addEventListener('click', downloadPrintSheet);
  pageSizeSelect.addEventListener('change', generatePrintSheet);
  orientationSelect.addEventListener('change', generatePrintSheet);
  marginInput.addEventListener('change', generatePrintSheet);
  colsInput.addEventListener('change', () => { if(colsInput.value<1) colsInput.value=1; generatePrintSheet(); });
  rowsInput.addEventListener('change', () => { if(rowsInput.value<1) rowsInput.value=1; generatePrintSheet(); });
  cropInput.addEventListener('change', generatePrintSheet);

  function handleFileSelect(e) {
    const newFiles = Array.from(e.target.files);
    newFiles.forEach(f => {
      const reader = new FileReader();
      reader.onload = ev => {
        files.push({ name: f.name, src: ev.target.result });
        renderThumbnails();
        generatePrintSheet();
      };
      reader.readAsDataURL(f);
    });
    e.target.value = null;
  }

  function renderThumbnails() {
    thumbs.innerHTML = '';
    files.forEach((f, i) => {
      const div = document.createElement('div');
      div.className = 'thumb';
      const img = document.createElement('img'); img.src = f.src; img.alt = f.name;
      const idx = document.createElement('div'); idx.className='idx'; idx.textContent = i+1;
      div.appendChild(img); div.appendChild(idx);
      thumbs.appendChild(div);
    });
  }

  // ---------- Layout calculation (tight 2x5 grid) ----------
  function calculateLayout(pageSize, orientation, margin, forcedCols, forcedRows) {
    const sizes = { letter: { w: 8.5, h: 11 }, a4: { w: 8.27, h: 11.69 } };
    const paper = sizes[pageSize] || sizes.letter;
    let pageW = orientation === 'portrait' ? paper.w : paper.h;
    let pageH = orientation === 'portrait' ? paper.h : paper.w;

    const usableW = pageW - 2 * margin;
    const usableH = pageH - 2 * margin;
    if (usableW <= 0 || usableH <= 0) return null;

    const cols = Math.max(1, parseInt(forcedCols) || 2);
    const rows = Math.max(1, parseInt(forcedRows) || 5);

    const finalCardW = cardDimensions.width;
    const finalCardH = cardDimensions.height;
    
    // Add small gap for cutting guidance (1/16 inch = 0.0625)
    const hGap = 0.0625;
    const vGap = 0.0625;

    // Check if cards fit at actual size with gaps
    const totalW = cols * finalCardW + (cols - 1) * hGap;
    const totalH = rows * finalCardH + (rows - 1) * vGap;

    if (totalW > usableW || totalH > usableH) {
      alert(`Cards don't fit at actual size (${cardDimensions.width}"×${cardDimensions.height}") with ${cols}×${rows} grid. Reduce grid size or increase margin.`);
      return null;
    }

    const cardsPerPage = cols * rows;
    const pagesCount = Math.max(1, Math.ceil(files.length / cardsPerPage));

    const pages = [];
    for (let i = 0; i < pagesCount; i++) {
      pages.push({
        pageWidth: pageW,
        pageHeight: pageH,
        cols, rows,
        hGap: hGap,
        vGap: vGap,
        cardW: finalCardW,
        cardH: finalCardH,
        scale: 1
      });
    }
    return pages;
  }

  // ---------- Create sheet DOM ----------
  function createSheet(page, pageIdx, margin, showCrop) {
    const sheet = document.createElement('div');
    sheet.className = 'sheet';
    sheet.style.width = page.pageWidth + 'in';
    sheet.style.height = page.pageHeight + 'in';

    const pageContent = document.createElement('div');
    pageContent.className = 'page-content';
    pageContent.style.padding = margin + 'in';
    pageContent.style.boxSizing = 'border-box';

    const grid = document.createElement('div');
    grid.className = 'grid';
    grid.style.gridTemplateColumns = `repeat(${page.cols}, ${page.cardW}in)`;
    grid.style.gridAutoRows = `${page.cardH}in`;
    grid.style.columnGap = page.hGap + 'in';
    grid.style.rowGap = page.vGap + 'in';
    grid.style.justifyContent = 'center';
    grid.style.alignContent = 'center';

    const totalSlots = page.cols * page.rows;
    for (let i = 0; i < totalSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      slot.style.width = page.cardW + 'in';
      slot.style.height = page.cardH + 'in';

      const cardBox = document.createElement('div');
      cardBox.className = 'card-box';
      cardBox.style.width = '100%';
      cardBox.style.height = '100%';
      cardBox.style.position = 'relative';

      const globalIdx = pageIdx * totalSlots + i;
      if (globalIdx < files.length) {
        const img = document.createElement('img');
        img.src = files[globalIdx].src;
        img.alt = files[globalIdx].name || ('card-' + (globalIdx+1));
        img.crossOrigin = 'Anonymous';
        cardBox.appendChild(img);
      }

      slot.appendChild(cardBox);
      if (showCrop) {
        const cut = document.createElement('div'); cut.className='cut';
        slot.appendChild(cut);
      }
      grid.appendChild(slot);
    }

    pageContent.appendChild(grid);
    sheet.appendChild(pageContent);
    return sheet;
  }

  // ---------- Generate ----------
  function generatePrintSheet() {
    const pageSize = pageSizeSelect.value;
    const orientation = orientationSelect.value;
    const margin = Math.max(0, parseFloat(marginInput.value) || 0.25);
    const forcedCols = Math.max(1, parseInt(colsInput.value) || 2);
    const forcedRows = Math.max(1, parseInt(rowsInput.value) || 5);
    const showCrop = cropInput.checked;

    const pages = calculateLayout(pageSize, orientation, margin, forcedCols, forcedRows);
    lastPages = pages;
    if (!pages) {
      pagesWrapper.innerHTML = '<p class="muted">Cannot fit any cards on this page with current margin/settings.</p>';
      printArea.innerHTML = '';
      return;
    }

    pagesWrapper.innerHTML = '';
    printArea.innerHTML = '';

    pages.forEach((page, idx) => {
      const sheet = createSheet(page, idx, margin, showCrop);
      pagesWrapper.appendChild(sheet);
      printArea.appendChild(sheet.cloneNode(true));
    });
  }

  // Wait for images in element
  function waitForImages(root) {
    const imgs = [...root.querySelectorAll('img')];
    if (imgs.length === 0) return Promise.resolve();
    return new Promise(resolve => {
      let left = imgs.length;
      imgs.forEach(img => {
        if (img.complete && img.naturalWidth !== 0) { left--; if (left === 0) resolve(); }
        else {
          img.addEventListener('load', () => { left--; if (left === 0) resolve(); }, { once: true });
          img.addEventListener('error', () => { left--; if (left === 0) resolve(); }, { once: true });
        }
      });
    });
  }

  // ---------- Download ----------
  async function downloadPrintSheet() {
    if (!lastPages || lastPages.length === 0) { alert('Generate a sheet first.'); return; }
    const offsheet = printArea.querySelector('.sheet');
    if (!offsheet) { alert('No sheet found. Generate first.'); return; }

    await waitForImages(offsheet);

    const page = lastPages[0];
    
    // Calculate exact pixel dimensions at 300 DPI
    const wPx = Math.round(page.pageWidth * DPI);
    const hPx = Math.round(page.pageHeight * DPI);

    // Create a temporary container with exact dimensions
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.width = page.pageWidth + 'in';
    tempContainer.style.height = page.pageHeight + 'in';
    tempContainer.style.background = '#ffffff';
    document.body.appendChild(tempContainer);
    
    const clonedSheet = offsheet.cloneNode(true);
    clonedSheet.style.width = page.pageWidth + 'in';
    clonedSheet.style.height = page.pageHeight + 'in';
    tempContainer.appendChild(clonedSheet);

    // Wait for cloned images
    await waitForImages(tempContainer);

    html2canvas(tempContainer, {
      scale: DPI / 96, // Convert CSS pixels to actual DPI (96 is default CSS DPI)
      useCORS: true,
      width: wPx,
      height: hPx,
      backgroundColor: '#ffffff',
      logging: false
    }).then(canvas => {
      // Verify canvas dimensions match expected
      console.log(`Canvas: ${canvas.width}×${canvas.height}px, Expected: ${wPx}×${hPx}px`);
      console.log(`Physical size: ${(canvas.width/DPI).toFixed(2)}"×${(canvas.height/DPI).toFixed(2)}"`);
      
      const a = document.createElement('a');
      a.download = 'affirmation-cards-sheet.png';
      a.href = canvas.toDataURL('image/png');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      document.body.removeChild(tempContainer);
    }).catch(err => {
      console.error(err);
      alert('Failed to generate PNG — check console.');
      document.body.removeChild(tempContainer);
    });
  }

  function clearAll() {
    files = [];
    thumbs.innerHTML = '';
    pagesWrapper.innerHTML = '';
    printArea.innerHTML = '';
    fileInput.value = null;
    lastPages = null;
  }

  // Init
  window.addEventListener('load', () => { /* nothing */ });
  </script>
</body>
</html>
